<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chicago Crime By Year</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="Serverless map of Chicago crime using Flex.io">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="twitter:title" content="Chicago Crime By Year">
    <meta name="twitter:description" content="Serverless map of Chicago crime using Flex.io">

    <meta property="og:title" content="Chicago Crime By Year">
    <meta property="og:url" content="https://github.com/flexiodata/examples/tree/master/demo-webpage-thumbnail-generator">
    <meta property="og:description" content="Serverless map of Chicago crime using Flex.io">

    <link rel="apple-touch-icon" href="https://s3.amazonaws.com/flexio-app-assets/apple-touch-icon.png">
    <link rel="icon" href="https://s3.amazonaws.com/flexio-app-assets/favicon.png">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600,700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.6.1/tachyons.min.css" integrity="sha256-eu1dpzpUytdOAUmB67Qi3mBb6HFjruP8BoAzk4lKiSc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.1/load5.css">

    <style>
      html, body {
        font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
        height: 100%;
        margin: 0;
      }

      /* Same as .flex-auto in Tachyons except without the 'auto' flex-basis */

      .flex-fill {
        flex: 1 1;
        min-width: 0; /* 1 */
        min-height: 0; /* 1 */
      }

      /* Button hover */

      .darken-10:hover,
      .darken-10:focus {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.10)
      }

      .darken-10:active {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.20)
      }
    </style>
  </head>
  <body>
    <div class="flex flex-column fixed absolute--fill overflow-hidden">
      <div class="flex flex-row items-center pa3 bb b--black-20">
        <div class="flex-none f4 fw6 ma0">Chicago Homicides By Year</div>
        <form class="flex flex-row ml3">
          <select class="year-select ba b--black-20 pv1 ph2 f6" name="year"></select>
          <button type="button" class="btn-submit border-box no-select ba ttu b f6 ph3 pv2 br1 white bg-blue b--blue darken-10 ml2">Submit</button>
        </form>
      </div>
      <div id="map" class="flex-fill"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

    <!-- site javascript goes here -->
    <script>
      var g_map
      var g_markers = []

      function initMap()
      {
        var chicago = {
          lat: 41.8781,
          lng:-87.6378
        }

        g_map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: chicago
        })
      }

      $(function() {
        var $btn = $('.btn-submit')

        // fill out select with years

        var cur_year = new Date().getFullYear()
        var opts = ''

        for (var y = 2001; y <= cur_year; ++y)
        {
          opts += '<option value="'+y+'">'+y+'</option>'
        }

        $('.year-select').append(opts).val(cur_year-1)

        var doSubmit = function()
        {
          // disable submit button
          $btn.addClass('o-40').text('Loading...').prop('disabled', 'true')

          // clear all existing markers
          for (var i = 0; i < g_markers.length; ++i)
          {
            g_markers[i].setMap(null)
          }
          g_markers = []

          $.ajax({
            type: 'POST',
            url: 'https://www.flex.io/api/v1/pipes/examples-demo-chicago-crime-map/run?flexio_api_key=rryrjgqhvtdttzzsjpjr',
            data: $('form').serialize(),
            dataType: 'json',
            success: function (coords) {
              // enable submit button
              $btn.removeClass('o-40').text('Submit').removeProp('disabled')

              // add new markers
              var marker

              for (var i = 0; i < coords.length; ++i)
              {
                var coord = {
                  lat: parseFloat(coords[i].latitude),
                  lng: parseFloat(coords[i].longitude)
                }

                marker = new google.maps.Marker({
                  position: coord,
                  map: g_map
                })

                marker.info = new google.maps.InfoWindow({
                  content: '<p><b>'+coords[i].description+'</b><br/>'+
                           coords[i].date+'</p>' +
                           '<p>'+coords[i].block+'<br/>'+
                           coords[i]['location description']+'</p>'
                })

                marker.addListener('click', function() {
                  this.info.open(this.getMap(), this)
                })

                g_markers.push(marker)
              }

              // feedback for user if no results
              if (coords.length == 0)
                alert('There are no results for that year.')
            },
            error: function () {
              alert("Something went wrong and we couldn't complete the request.")
            }
          })
        }

        $('form').on('submit', function (evt) {
          evt.preventDefault()
          doSubmit()
        })

        $('.btn-submit').click(function(evt) {
          doSubmit()
        })

        // start off by doing an inital submit for the current year
        doSubmit()
      })
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxfb6JACKlfD6IJLQlmvj3Gwo_ynvbXt4&callback=initMap"></script>
  </body>
</html>
